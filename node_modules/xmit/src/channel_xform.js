
/** 
 * @class ChannelXform
 * 	A subclass of ChannelAtom... 
 * 	it is exactly like Channel.... except that 
 * 	when the listeners run each listener passes a new value
 * 	
 * 	most functions are called via wrapper functions in the parent 
 * 	xmitter
 */

// var log = require("xbrowser_debug").log;

var Atom = require("./channel_atom")

function ChannelXform(name, context) { 
	this.init(name, context);
}

/** 
 * subclass from ChannelAtom
 */
ChannelXform.prototype = Object.create(Atom.prototype);

/** 
 *  @function on
 * 		add a listener to this channel
 * 		
 * 
 * 	@return the channel	
 * 
 * 	@param {function} lambda--- the listener
 *  @context {object} -- the context to run this function .
 *
 */
ChannelXform.prototype.on = function(lambda, context) { 
	// prepend all listeners instead of append
	context = context||this;
	this._listeners.unshift(function(msg) { 
		return lambda.call(context, msg);
	});
	return this;
}

/**
 * @function xmit
 * 		runs the listeners in FIFO order.. 
 * 		replacing the msg with the return value of each listener
 * @param {*} msg
 * 
 * 	
 */
ChannelXform.prototype.xmit = function(msg) { 
	var _ls = this._listeners, _l = _ls.length, i = i|0;
	if (_l===0) return msg;
	if (_l===1) return _ls[0](msg);

	for ( ; i !== _l; i++ ) {
		msg = _ls[i](msg);
	}
	return msg;
} 

ChannelXform.prototype.toString = function() { 
	return "XMIT CHANNEL X FORM"
}


module.exports = ChannelXform;
